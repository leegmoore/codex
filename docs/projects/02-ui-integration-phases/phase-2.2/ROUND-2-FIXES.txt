===== PHASE 2.2: ROUND 2 FIXES - VERIFIER FEEDBACK =====

ROLE: You are continuing Phase 2.2 implementation. The verifier found 3 issues that need fixing before approval.

---

CONTEXT:

You completed the initial Phase 2.2 implementation:
- ✅ Config loading (approval_policy, sandbox_policy, reasoning)
- ✅ Approval policy enforcement (never, on-failure, on-request)
- ✅ Tool iteration limit increased to 100
- ✅ Perplexity integration fixed
- ✅ Duplicate tool display removed

The verifier ran all checks and found issues requiring fixes.

---

VERIFIER RESULTS:

Stage 1: Mechanical Checks
- ✅ npm run lint: PASS
- ✅ npx tsc --noEmit: PASS (0 errors)
- ✅ npm test: PASS (1,938 tests)
- ✅ npm run build: PASS
- ❌ npm run format: FAIL (but see clarification below)

Stage 2: Code Review
- ✅ Config loading: GOOD
- ✅ Perplexity integration: GOOD
- ✅ Duplicate display: GOOD
- ✅ Regression check: PASS
- ❌ Approval policy "untrusted": Not implemented correctly
- ⚠️ Documentation: Deferred items not documented

---

REQUIRED FIXES:

## Fix 1: Remove "untrusted" Policy (Critical)

**Problem:** The `untrusted` approval policy is in the valid list but not properly implemented. It currently falls through to the same behavior as `on-request`.

**Decision:** Remove `untrusted` from supported policies. It will be implemented in a future phase as part of a comprehensive structured permission system.

**Changes Required:**

### File: codex-ts/src/cli/config.ts

Current code in `normalizeApprovalPolicy()`:
```typescript
const valid: AskForApproval[] = ['never', 'on-failure', 'on-request', 'untrusted'];
```

Change to:
```typescript
const valid: AskForApproval[] = ['never', 'on-failure', 'on-request'];
```

Update the error message:
```typescript
throw new ConfigurationError(
  `Invalid approval_policy: "${value}". Valid values: ${valid.join(', ')}. ` +
  `Note: 'untrusted' policy deferred to future release.`
);
```

### File: codex-ts/src/cli/config.test.ts

Add a test that verifies `untrusted` is rejected with helpful message:

```typescript
it('should reject unsupported "untrusted" policy with helpful message', () => {
  const config = {
    auth: {
      method: 'api-key' as const,
      openai_key: 'test-key'
    },
    approval_policy: 'untrusted'
  };

  expect(() => loadCliConfig(config, '/tmp')).toThrow(
    /Invalid approval_policy.*untrusted.*deferred to future release/
  );
});
```

Remove any existing tests that use `approval_policy: 'untrusted'`.

---

## Fix 2: Format Check Scope (Clarification)

**Problem:** Verifier ran `npm run format` at repo root and found 9 files with formatting issues (AGENTS.md, README.md, test-transcript-01.md, etc.).

**Clarification:** Those files are OUTSIDE the Phase 2.2 scope. Phase 2.2 only modifies files in `codex-ts/` directory.

**Action Required:**

Run format check from `codex-ts/` directory only:
```bash
cd codex-ts
npm run format
```

All files you modified should already be formatted. No code changes needed for this.

---

## Fix 3: Document Deferred Items

**Problem:** Checklist has unchecked items for deferred work with no explanation.

**Action Required:**

### Create file: docs/projects/02-ui-integration-phases/phase-2.2/decisions.md

```markdown
# Phase 2.2 Implementation Decisions

## Date
2025-01-14

## Critical Fixes Implemented

### 1. Config Loading Enhancement
- Added parsing for `approval_policy`, `sandbox_policy`, `model_reasoning_effort`, `model_reasoning_summary`
- Created normalization functions with validation
- All config fields now loaded from ~/.cody/config.toml

### 2. Approval Policy Enforcement
- Implemented `never` (auto-approve all)
- Implemented `on-failure` (auto-approve, escalate on error)
- Maintained existing `on-request` behavior (prompt for approval)
- **Deferred:** `untrusted` policy (see below)

### 3. Tool Iteration Limit
- Increased from 6 to 100
- Allows complex multi-tool workflows to complete
- Still provides safety against infinite loops

### 4. Perplexity Integration
- Renamed `webSearch` → `perplexitySearch`
- Updated model: `llama-3.1-sonar-small-128k-online` → `sonar-reasoning-pro`
- Created new `webSearch` tool using proper Perplexity Search API

### 5. UX Improvements
- Removed duplicate tool display from approval.ts
- Tool now shown once (in display.ts only)

## Deferred Items

### Untrusted Approval Policy
- **Status:** Deferred to future release
- **Rationale:** Requires comprehensive structured permission system design
- **Scope:** Selective auto-approval based on tool risk levels (e.g., auto-approve read-only tools, prompt for write/exec)
- **Implementation:** Will be part of larger policy/permissions feature
- **Current:** Removed from valid policy options with helpful error message

### Issue 9: fetchUrl Error Logging
- **Status:** Deferred - low priority
- **Rationale:** fetchUrl works correctly, just needs better diagnostics
- **Implementation:** Add full Firecrawl response object to error message (5-minute fix)
- **Priority:** Low - can be done anytime

### Issue 10: readMcpResource Stub
- **Status:** Deferred to Phase 5 (MCP Implementation)
- **Rationale:** Full MCP support is Phase 5 scope
- **Current State:** Throws "not yet implemented" - acceptable for now

### Issue 8: Approval Input Echo Bug
- **Status:** Deferred - requires investigation
- **Rationale:** Low priority UX issue, doesn't affect functionality
- **Symptom:** Typing 'y' displays as 'yy' in some terminals
- **Investigation needed:** Readline/stdin buffering configuration

## Test Coverage

- Config loading: Full unit test coverage
- Approval policy: Tests for `never`, `on-failure`, `on-request`
- Perplexity: Unit tests for both perplexitySearch and webSearch
- Regression: All 1,938 existing tests still pass

## Manual Testing Required

To be performed after verification approval:
1. Test `approval_policy="never"` (auto-approve)
2. Test `approval_policy="on-request"` (prompts)
3. Test complex multi-tool task (>6 tools)
4. Test perplexitySearch with valid model
5. Test webSearch returns search results
6. Verify no duplicate tool display
```

### Update file: docs/projects/02-ui-integration-phases/phase-2.2/source/checklist.md

Find the optional/deferred items section and update:

```markdown
## Issue 9: fetchUrl Error Logging (Optional - Low Priority)
- [x] Deferred - see decisions.md

## Issue 10: readMcpResource Stub (Optional - Defer to Phase 5)
- [x] Deferred to Phase 5 - see decisions.md

## Documentation
- [x] Update decisions.md with changes
- [x] Document approval policy behavior
- [x] Document tool renaming
- [x] Note deferred items (Firecrawl, MCP, untrusted policy)
```

---

EXECUTION WORKFLOW:

1. Fix `normalizeApprovalPolicy()` in config.ts (remove 'untrusted')
2. Update error message to mention deferral
3. Add/update tests in config.test.ts
4. Create decisions.md documenting all changes and deferrals
5. Update checklist.md to mark deferred items complete
6. Run quality checks from codex-ts/ directory:
   ```bash
   cd codex-ts
   npm run format
   npm run lint
   npx tsc --noEmit
   npm test
   ```
7. Commit changes

---

COMPLETION CHECKLIST:

Before declaring complete:

- [ ] `normalizeApprovalPolicy()` only accepts: never, on-failure, on-request
- [ ] Error message mentions 'untrusted' is deferred
- [ ] Test added/updated for rejecting 'untrusted' policy
- [ ] decisions.md created with all sections
- [ ] checklist.md updated to mark deferred items
- [ ] All quality checks pass from codex-ts/ directory
- [ ] Changes committed

---

EXPECTED OUTCOME:

After these fixes:
- Verifier mechanical checks: ALL PASS
- Verifier code review: APPROVED
- Documentation: COMPLETE
- Ready for manual testing

===== END ROUND 2 FIXES =====
