===== PHASE 2.2: CODER PROMPT =====
ROLE: Senior TypeScript developer implementing Phase 2.2 of the Cody CLI integration project. You write clean, tested code following TDD principles with service-mocked tests at library boundaries.


---

PRODUCT:

**Cody** is a command-line interface for the Codex TypeScript library. It provides multi-provider LLM agent capabilities supporting OpenAI (Responses, Chat) and Anthropic (Messages) APIs with tool execution, conversation persistence, and structured tool calling. Built as a TypeScript port of OpenAI's Rust-based Codex CLI, Cody serves as both a standalone CLI tool and reference implementation for the @openai/codex-core library.


---

PROJECT CONTEXT:

# Project 02: UI Integration & Library Definition

## What We're Building

Project 02 integrates all ported Codex modules (Phases 1-6) into a working command-line interface called **Cody** and defines the library API surface for @openai/codex-core. This project validates the Rust â†’ TypeScript port by wiring protocol, configuration, persistence, execution, client, tools, and orchestration layers into complete conversation flows.

## Current Status

- Phase 1 âœ… COMPLETE - Basic chat flow working
- Phase 2 âœ… COMPLETE - Tool integration wired
- Phase 2.1 âœ… COMPLETE - Config loading enhanced, UX improved
- **Phase 2.2 IN PROGRESS** - Critical tool system fixes & refinements

## Dependencies

- Phase 2.1 complete (config loading foundation)
- Tool test report analyzed (specific failures identified)
- API keys: OpenAI, Anthropic, Perplexity

## Scope

Phase 2.2 fixes critical issues discovered through systematic tool testing:
- Approval policy enforcement (unblocks applyPatch & exec)
- Tool iteration limit increase
- Perplexity integration fixes
- UX refinements


---

PHASE 2.2 CRITICAL ISSUES:

From systematic tool testing, we discovered these blocking issues:

**Issue 1: Approval Policy Not Enforced (CRITICAL)**
- Config has `approval_policy` setting but it's NEVER consulted
- All tools with `requiresApproval: true` ALWAYS prompt, even when policy="never"
- Non-interactive mode hangs waiting for approval â†’ 60s timeout â†’ CodexInternalAgentDiedError
- **Blocks:** applyPatch, exec (both unusable)
- **Root Cause:** approval_policy stored in session but never checked before calling approvalCallback
- **Evidence:** Tool test report shows timeout failures for both tools

**Issue 2: Tool Iteration Limit Too Low**
- MAX_TOOL_ITERATIONS = 6 (session.ts line 44)
- Complex tasks fail with "Too many tool call iterations"
- Example: Modify file task â†’ 6+ tools called â†’ hits limit â†’ task incomplete
- Not an infinite loop - just artificial ceiling too low

**Issue 3: Invalid Perplexity Model**
- webSearch tool uses deprecated model "llama-3.1-sonar-small-128k-online"
- All searches fail with 400 "Invalid model" error
- Valid models (2025): sonar, sonar-pro, sonar-reasoning, sonar-reasoning-pro

**Issue 4: webSearch Naming Confusion**
- Tool named "webSearch" but calls Perplexity chat/completions (reasoning model)
- Doesn't do actual web search
- Should be renamed to "perplexitySearch" and use sonar-reasoning-pro

**Issue 5: Duplicate Tool Display**
- Tools shown twice: once in approval.ts, once in display.ts
- Cluttered output

**Issue 6: Config Loading Incomplete (from Phase 2.1)**
- Only reads provider/auth
- Ignores: approval_policy, sandbox_policy, reasoning settings
- Blocks Issue #1 fix


---

TECHNICAL DESIGN:

See phase-2.2/source/design.md for complete details. Key implementation points:

## Fix 1: Complete Config Loading (Prerequisite)

File: codex-ts/src/cli/config.ts

Add after line 67:

```typescript
// Parse approval policy
if (cliConfig.approval_policy) {
  const policy = normalizeApprovalPolicy(cliConfig.approval_policy);
  core.approvalPolicy = policy;
}

// Parse sandbox policy  
if (cliConfig.sandbox_policy) {
  core.sandboxPolicy = normalizeSandboxPolicy(cliConfig.sandbox_policy);
}

// Parse reasoning effort
if (cliConfig.model_reasoning_effort) {
  core.modelReasoningEffort = normalizeReasoningEffort(cliConfig.model_reasoning_effort);
}

// Parse reasoning summary
if (cliConfig.model_reasoning_summary !== undefined) {
  core.modelReasoningSummary = cliConfig.model_reasoning_summary;
}
```

Helper functions:

```typescript
function normalizeApprovalPolicy(value: string): AskForApproval {
  const valid: AskForApproval[] = ['never', 'on-failure', 'on-request', 'untrusted'];
  if (valid.includes(value as AskForApproval)) {
    return value as AskForApproval;
  }
  throw new ConfigurationError(
    `Invalid approval_policy: "${value}". Valid values: ${valid.join(', ')}`
  );
}

function normalizeSandboxPolicy(value: string): SandboxMode {
  const valid = ['read-only', 'full-access', 'isolated'];
  // Implement similar validation
}

function normalizeReasoningEffort(value: string): ReasoningEffort {
  const valid = ['low', 'medium', 'high'];
  if (valid.includes(value)) {
    return value as ReasoningEffort;
  }
  throw new ConfigurationError(
    `Invalid model_reasoning_effort: "${value}". Valid values: ${valid.join(', ')}`
  );
}
```

## Fix 2: Enforce Approval Policy

File: codex-ts/src/core/codex/session.ts - executeFunctionCalls() method

BEFORE calling toolRouter, check policy:

```typescript
private async executeFunctionCalls(responseItems: ResponseItem[]): Promise<ResponseItem[]> {
  const policy = this._state.settings.approvalPolicy || 'on-request';
  const functionCalls = responseItems.filter(item => item.type === 'function_call');

  // Auto-approve based on policy
  if (policy === 'never') {
    // Execute all without approval
    return await this.toolRouter.executeFunctionCalls(functionCalls);
  }

  if (policy === 'on-failure') {
    // Execute with auto-approve, escalate only on error
    try {
      return await this.toolRouter.executeFunctionCalls(functionCalls);
    } catch (error) {
      // On failure, fall through to approval flow
    }
  }

  // 'on-request' or 'untrusted' - existing approval flow
  return await this.toolRouter.executeFunctionCalls(functionCalls);
}
```

## Fix 3: Increase Iteration Limit

File: codex-ts/src/core/codex/session.ts line 44

```typescript
// Before:
const MAX_TOOL_ITERATIONS = 6;

// After:
const MAX_TOOL_ITERATIONS = 100;
```

## Fix 4: Rename webSearch â†’ perplexitySearch

File: codex-ts/src/tools/web/search.ts

1. Rename function: webSearch â†’ perplexitySearch
2. Update model: "llama-3.1-sonar-small-128k-online" â†’ "sonar-reasoning-pro"
3. Update description

File: codex-ts/src/tools/registry.ts

1. Update registration: name: "perplexitySearch"
2. Update description: "Perform reasoning-based search using Perplexity Sonar Reasoning Pro"

## Fix 5: Remove Duplicate Tool Display

File: codex-ts/src/cli/approval.ts

Remove lines 10-11:
```typescript
// DELETE:
console.log(`ðŸ”§ Tool call: ${tool}`);
console.log(`   Args: ${JSON.stringify(args, null, 2)}`);
```

Keep only approval question. Display happens in display.ts.


---

TEST CONDITIONS:

See phase-2.2/source/test-conditions.md for complete test scenarios.

Key tests:

1. Config with approval_policy="never" â†’ tools execute without prompt
2. Config with approval_policy="on-request" â†’ approval prompts appear
3. Complex task with >6 tools â†’ completes successfully (no iteration limit error)
4. perplexitySearch uses sonar-reasoning-pro â†’ no 400 error
5. Tool displayed once (not duplicate)
6. applyPatch works without timeout
7. exec works without timeout


---

TASKS (update source/checklist.md as you work):

## Priority 1: Config & Approval (Critical Path)

1. Config loading enhancement (cli/config.ts):
   - Create normalizeApprovalPolicy()
   - Create normalizeSandboxPolicy()
   - Create normalizeReasoningEffort()
   - Update loadCliConfig() to parse all fields
   - Write unit tests

2. Approval policy enforcement (session.ts):
   - Read current executeFunctionCalls()
   - Add policy check before tool execution
   - Implement auto-approve for "never"
   - Implement auto-approve with escalation for "on-failure"
   - Write tests for each policy

3. Manual verification:
   - Test approval_policy="never" (no prompts)
   - Test applyPatch works
   - Test exec works
   - No timeout errors

## Priority 2: Tool System Fixes

4. Increase iteration limit (session.ts line 44):
   - Change 6 â†’ 100
   - Test with complex multi-tool task

5. Perplexity renaming (tools/web/search.ts, tools/registry.ts):
   - Rename webSearch â†’ perplexitySearch
   - Update model to sonar-reasoning-pro
   - Update registration

6. Remove duplicate display (cli/approval.ts):
   - Delete console.log lines 10-11
   - Test tool shown once

## Priority 3: Quality & Documentation

7. Quality verification:
   - npm run format
   - npm run lint
   - npx tsc --noEmit
   - npm test

8. Documentation:
   - Update decisions.md
   - Document approval policy behavior
   - Note tool renaming


---

STANDARDS:

See docs/core/dev-standards.md for complete coding standards.

Key requirements:
- TypeScript strict mode, no any types
- ESLint 0 errors
- Prettier formatted
- Service-mocked tests at library boundaries
- Mock all external dependencies


---

EXECUTION WORKFLOW:

1. Read all reference documents (design.md, checklist.md, test-conditions.md)
2. Understand current approval flow (session.ts, approval.ts, tool-router.ts)
3. Understand current config loading (cli/config.ts)
4. Implement fixes in order (config first, then approval, then other fixes)
5. Write tests for each fix
6. Manual functional testing (follow manual-test-script.md)
7. Quality verification (format, lint, typecheck, tests)
8. Update artifacts (checklist.md, decisions.md)
9. Commit and report completion

DO NOT declare phase complete until all steps verified.


---

MANUAL VERIFICATION:

See phase-2.2/source/manual-test-script.md for complete manual testing procedure.

Critical tests:

Test 1: Auto-approve works
```bash
cat > ~/.cody/config.toml << 'EOF'
model = "gpt-5-codex"
approval_policy = "never"
EOF
npm run build
cody chat "run command: echo test"
```
Expected: No prompt, tool executes, no timeout

Test 2: applyPatch works
```bash
echo "content" > /tmp/test.txt
cody chat "add line to /tmp/test.txt using applyPatch"
```
Expected: No timeout, patch applied

Test 3: Iteration limit increased
```bash
cody chat "read README, find links, check files, summarize"
```
Expected: 10+ tools execute, no iteration error


---

FINAL QUALITY CHECK:

Before declaring phase complete:

Run: npm run format && npm run lint && npx tsc --noEmit && npm test

ALL must pass. Document results.
Update checklist.md and decisions.md.
Commit and push.
Ready for verification stages.

===== END CODER PROMPT =====
