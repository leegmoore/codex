===== PHASE 2.2: ROUND 2 VERIFICATION =====

ROLE: Quality verifier for Phase 2.2 Round 2 fixes. You are verifying that the coder addressed the 3 issues identified in Round 1 verification.

---

CONTEXT:

Round 1 Verification identified 3 issues:
1. ❌ "untrusted" approval policy not implemented
2. ⚠️ Format check ran at wrong scope (repo root instead of codex-ts/)
3. ❌ Deferred items not documented

Coder was given ROUND-2-FIXES.txt prompt with specific instructions to:
- Remove "untrusted" from valid policies (defer to future)
- Create decisions.md documenting deferrals
- Update checklist.md

---

VERIFICATION SCOPE:

This is a focused verification of Round 2 fixes ONLY. Do NOT re-verify the entire Phase 2.2 implementation.

Focus areas:
1. Config validation properly rejects "untrusted"
2. Documentation complete (decisions.md created)
3. Mechanical checks pass from correct scope

---

STAGE 1: MECHANICAL CHECKS

Run ALL checks from codex-ts/ directory (NOT repo root):

```bash
cd codex-ts
npm run format    # Should exit 0, no changes
npm run lint      # Should exit 0 (existing warnings OK)
npx tsc --noEmit  # Should exit 0 (0 type errors)
npm test          # Should exit 0 (all tests pass)
npm run build     # Should succeed
```

**IMPORTANT:**
- Run format/lint/typecheck from `codex-ts/` directory ONLY
- Files outside codex-ts/ (like AGENTS.md, README.md) are NOT in Phase 2.2 scope
- Only verify files the coder actually modified

Record results for all 5 checks.

---

STAGE 2: CODE REVIEW

### Review 1: "untrusted" Policy Removed

**File:** codex-ts/src/cli/config.ts

**Check:**
- [ ] `normalizeApprovalPolicy()` valid array contains ONLY: `['never', 'on-failure', 'on-request']`
- [ ] Does NOT contain 'untrusted'
- [ ] Error message mentions that 'untrusted' is deferred to future release
- [ ] Error message is helpful and clear

**File:** codex-ts/src/cli/config.test.ts

**Check:**
- [ ] Test exists verifying 'untrusted' is rejected
- [ ] Test verifies error message mentions deferral
- [ ] No tests using `approval_policy: 'untrusted'` remain

**File:** codex-ts/src/core/codex/session.ts

**Check:**
- [ ] executeFunctionCalls() does NOT have special handling for 'untrusted'
- [ ] Only handles: 'never', 'on-failure', and default (on-request)

### Review 2: Documentation Complete

**File:** docs/projects/02-ui-integration-phases/phase-2.2/decisions.md

**Check:**
- [ ] File exists
- [ ] Documents all implemented fixes (config, approval, iteration, perplexity, UX)
- [ ] Has "Deferred Items" section
- [ ] Documents untrusted policy deferral with rationale
- [ ] Documents fetchUrl logging deferral (low priority)
- [ ] Documents readMcpResource deferral (Phase 5)
- [ ] Documents approval input echo deferral (needs investigation)
- [ ] Clear and well-organized

**File:** docs/projects/02-ui-integration-phases/phase-2.2/source/checklist.md

**Check:**
- [ ] Deferred items marked as complete with "(Deferred - see decisions.md)" note
- [ ] Documentation section items checked off

### Review 3: Regression Check

**Quick check:**
- [ ] No new TypeScript errors introduced
- [ ] No new ESLint errors introduced
- [ ] Test count maintained (should still be ~1,938 tests)
- [ ] All tests passing

---

WORKFLOW:

1. **Run ALL Stage 1 checks** from codex-ts/ directory - Record all results
2. **Complete Stage 2 reviews** - Check all items
3. **Generate structured report** (format below)
4. **Make decision**: APPROVED / CONDITIONAL / REJECTED

**IMPORTANT NOTES:**
- Continue through ALL checks even if some fail
- Manual testing is the coder's responsibility (happens after verification)
- Format scope is codex-ts/ directory only
- Iteration limit verification will happen in manual testing (not automated)

---

REPORTING FORMAT:

Generate a structured report:

```markdown
# VERIFICATION REPORT - PHASE 2.2 ROUND 2

## Overall Status
[APPROVED / CONDITIONAL / REJECTED]

## Stage 1: Mechanical Checks (codex-ts/ scope)

| Check | Status | Notes |
|-------|--------|-------|
| npm run format | PASS/FAIL | [details] |
| npm run lint | PASS/FAIL | [existing warnings OK] |
| npx tsc --noEmit | PASS/FAIL | [X errors] |
| npm test | PASS/FAIL | [X/Y tests] |
| npm run build | PASS/FAIL | [details] |

## Stage 2: Code Review

### Review 1: "untrusted" Policy Removed
**Status:** GOOD / ISSUES

Issues found:
- [list any with file:line references]

### Review 2: Documentation Complete
**Status:** COMPLETE / INCOMPLETE

Issues found:
- [list any missing sections or clarity issues]

### Review 3: Regression Check
**Status:** PASS / FAIL

Issues found:
- [list any regressions]

## Summary

**What was fixed:**
- [list verified fixes]

**Remaining issues (if any):**
- [list with severity]

## Decision Rationale

[Explain why APPROVED/CONDITIONAL/REJECTED]

## Next Steps

[What should happen next]
```

---

DECISION CRITERIA:

**APPROVED if:**
- All mechanical checks pass (from codex-ts/ directory)
- 'untrusted' properly removed with helpful error message
- decisions.md complete with all deferred items documented
- No new regressions
- All Round 2 fixes verified

**CONDITIONAL if:**
- Minor documentation gaps (missing clarity, not missing sections)
- 1-2 small non-critical issues that can be quickly fixed

**REJECTED if:**
- Mechanical checks fail
- 'untrusted' still in valid policy list
- decisions.md missing or incomplete
- New regressions introduced

---

START by running Stage 1 mechanical checks from codex-ts/ directory, then proceed to Stage 2 reviews regardless of results. Generate complete report.

===== END ROUND 2 VERIFICATION =====
