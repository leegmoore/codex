===== PHASE 4: CODER PROMPT =====
You are a senior TypeScript engineer implementing Phase {{PHASE}} of Project 03 (script harness). Read every referenced doc, apply Cody dev standards, and update checklist/decisions as you work.


---

PRODUCT:

Cody (CLI + library) now supports script-based tool calling alongside structured function calls. Scripts are TypeScript snippets wrapped in `<tool-calls>` blocks that run inside a hardened QuickJS runtime and route through the existing tool registry, approvals, and persistence layers.


---

PROJECT CONTEXT:

- **Goal:** Make script harness a first-class capability so models can compose multiple tools in a single turn while sharing the same tool registry as structured calls.
- **Why:** Structured tool calls require one JSON payload per turn; scripts shrink multi-step workflows, unlock cheap models, and provide deterministic automation for humans.
- **Deliverables:** End-to-end harness, CLI/REST UX, documentation, and benchmark report showing improved workflow completion rates.
- **Constraints:** QuickJS sandbox only, scripts capped at 20 KB / 32 tool calls / 5 s runtime, no direct host APIs, approvals identical to structured path.


---

PHASE 4 TECHNICAL DESIGN:

# Phase 4 Design – Approval Bridge & UX

## Objective
Extend the approval system to scripts so dangerous tools pause execution, display script metadata to the user, and resume cleanly once a decision is made. Capture audit records for every script run.

## Components

1. **Approval Bridge:** integrates with tool facade; when a tool requires approval, orchestrator suspends QuickJS (Asyncify), prompts user with script hash, allowed tools, truncated arguments, and awaits approval/denial. Denials throw `ScriptApprovalDeniedError` into the script.
2. **Metadata + Audit Logging:** compute script hash + normalized tool list, log decisions (approved/denied, user, timestamp) into conversation history/persistence.
3. **CLI UX:** approval prompts show script excerpt, hash, counts of tools used/remaining, and outstanding detached tasks.

## Notes
- Ensure suspension/resume works for multiple approvals within one script.
- Audit log entry should exist even if script fails later.


---

TEST CONDITIONS:

# Phase 4 Test Conditions

1. Approval flow: tool requiring approval pauses script, prompt displayed, approval resumes execution, result returned.
2. Denial flow: denial prevents tool execution and script receives `ScriptApprovalDeniedError`.
3. Multiple approvals in one script succeed without deadlocks.
4. Audit log written with hash, tool list, decisions (inspect persistence/mock logger).
5. CLI prompt renders snippet/hash/tool info as designed.


---

TASKS (update source/checklist.md as you work):

# Checklist – Phase 4

- [ ] Build approval bridge with Asyncify suspension
- [ ] Compute script hash + metadata for prompts/logs
- [ ] Update CLI approval UI (snippet, hash, tool counts)
- [ ] Write audit logger
- [ ] Tests per test-conditions.md
- [ ] Manual approval/denial walkthrough


---

STANDARDS:

See docs/core/dev-standards.md for complete coding standards.
See docs/core/contract-testing-tdd-philosophy.md for testing approach.

Key requirements:
- TypeScript strict mode, no any types
- ESLint 0 errors
- Prettier formatted
- Mocked-service tests at library boundaries
- Mock all external dependencies


---

EXECUTION WORKFLOW:

1. Read artifacts (design, tests, manual script, checklist) and relevant source files.
2. Write/extend mocked-service tests first until they fail for the right reason.
3. Implement code to satisfy tests, following dev standards and keeping approvals/tool registry invariants intact.
4. Run manual script checklist if provided.
5. Update checklist.md (mark completed tasks) and record noteworthy choices in decisions.md.


---

MANUAL VERIFICATION:

# Phase 4 Manual Script

1. Run script calling exec + applyPatch (both approval-required). Observe prompt with script hash/snippet.
2. Approve first, deny second, confirm script catches denial (try/catch) and CLI logs both decisions.
3. Review audit log (CLI or log file) to confirm entries.


---

FINAL QUALITY CHECK:

Before declaring phase complete:

Run: npm run format && npm run lint && npx tsc --noEmit && npm test

ALL must pass. Document results.
Update checklist.md and decisions.md.
Commit and push.
Ready for verification stages.

===== END CODER PROMPT =====
