===== PHASE 2: CODER PROMPT =====
You are a senior TypeScript engineer implementing Phase {{PHASE}} of Project 03 (script harness). Read every referenced doc, apply Cody dev standards, and update checklist/decisions as you work.


---

PRODUCT:

Cody (CLI + library) now supports script-based tool calling alongside structured function calls. Scripts are TypeScript snippets wrapped in `<tool-calls>` blocks that run inside a hardened QuickJS runtime and route through the existing tool registry, approvals, and persistence layers.


---

PROJECT CONTEXT:

- **Goal:** Make script harness a first-class capability so models can compose multiple tools in a single turn while sharing the same tool registry as structured calls.
- **Why:** Structured tool calls require one JSON payload per turn; scripts shrink multi-step workflows, unlock cheap models, and provide deterministic automation for humans.
- **Deliverables:** End-to-end harness, CLI/REST UX, documentation, and benchmark report showing improved workflow completion rates.
- **Constraints:** QuickJS sandbox only, scripts capped at 20 KB / 32 tool calls / 5 s runtime, no direct host APIs, approvals identical to structured path.


---

PHASE 2 TECHNICAL DESIGN:

# Phase 2 Design – Full Tool Integration

## Objective
Expose the entire tool registry to scripts with schema validation, tool packs, and richer CLI output while retaining centralized control over budgets and approval metadata.

## Components

1. **Tool Facade (`tool_facade.ts`):**
   - Builds a proxy keyed by tool name.
   - Checks whitelist/pack membership before exposing a tool.
   - Validates args against existing JSON schemas (reuse structured call validators).
   - Tracks per-call metadata (start/end times, arg snippets) for later logging.

2. **Tool Pack Configuration (`script_config.ts`):**
   - Reads `scripts.yaml` or config entries to determine enabled packs.
   - CLI command `cody scripts tools` lists packs, shows which are active, and allows toggling.

3. **CLI Output Enhancements:**
   - Table summarizing tool calls (name, status, duration).
   - Verbose mode to print JSON args/results when requested.

## Notes
- Budget enforcement (max calls/concurrency) stays in facade so later approval bridge can piggyback on metadata.
- Keep default pack conservative (`core` only) to minimize approval noise.


---

TEST CONDITIONS:

# Phase 2 Test Conditions

1. Enabling packs exposes tools: with `file-ops` enabled, `tools.readFile` accessible; when disabled, access throws `ToolNotAllowedError`.
2. Schema validation fires: malformed args for `applyPatch` produce same error message as structured call path.
3. CLI listing shows packs, highlights active ones, and persists selection in config.
4. CLI verbose mode prints args/results only when `--verbose` supplied.
5. Budget counters increment per call; exceeding limit produces `ToolBudgetExceededError`.


---

TASKS (update source/checklist.md as you work):

# Checklist – Phase 2

- [ ] Implement tool facade proxy with pack enforcement
- [ ] Wire schema validation to existing validators
- [ ] Build script_config loader + CLI command
- [ ] Add CLI execution table + verbose mode
- [ ] Update docs (tool pack descriptions)
- [ ] Write tests from test-conditions.md
- [ ] Run manual script checklist


---

STANDARDS:

See docs/core/dev-standards.md for complete coding standards.
See docs/core/contract-testing-tdd-philosophy.md for testing approach.

Key requirements:
- TypeScript strict mode, no any types
- ESLint 0 errors
- Prettier formatted
- Mocked-service tests at library boundaries
- Mock all external dependencies


---

EXECUTION WORKFLOW:

1. Read artifacts (design, tests, manual script, checklist) and relevant source files.
2. Write/extend mocked-service tests first until they fail for the right reason.
3. Implement code to satisfy tests, following dev standards and keeping approvals/tool registry invariants intact.
4. Run manual script checklist if provided.
5. Update checklist.md (mark completed tasks) and record noteworthy choices in decisions.md.


---

MANUAL VERIFICATION:

# Phase 2 Manual Script

1. Enable packs: `cody scripts tools --enable file-ops`
2. Run script calling `tools.readFile` and `tools.applyPatch`; confirm CLI table shows both entries.
3. Disable `file-ops`, rerun script touching readFile → receive ToolNotAllowed error.
4. Run CLI verbose mode (`cody chat --scripts-verbose ...`) to ensure JSON args/results printed.


---

FINAL QUALITY CHECK:

Before declaring phase complete:

Run: npm run format && npm run lint && npx tsc --noEmit && npm test

ALL must pass. Document results.
Update checklist.md and decisions.md.
Commit and push.
Ready for verification stages.

===== END CODER PROMPT =====
